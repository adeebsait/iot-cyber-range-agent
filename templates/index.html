<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>IoT Cyber-Range Dashboard</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 1em auto;
      }
      h1, h2 { text-align: centre; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
      }
      th, td {
        padding: 0.5em;
        border: 1px solid #ccc;
      }
      th { background: #f0f0f0; }
      .alert {
        background: #ffecec;
        border: 1px solid #f5aca6;
        border-radius: 4px;
        padding: 0.75em;
        margin-bottom: 0.5em;
      }
    </style>
  </head>
  <body>
    <h1>Real-Time IoT Alerts</h1>

    <section id="summary">
      <h2>Model Vote Counters</h2>
      <table>
        <thead>
          <tr><th>Model</th><th>Positive Votes</th></tr>
        </thead>
        <tbody id="summary-body"></tbody>
      </table>
      <p><strong>Total Ensemble Alerts:</strong>
        <span id="total-alerts">0</span>
      </p>
    </section>

    <section id="alerts">
      <h2>Alert Feed</h2>
    </section>

    <script>
      // Parse the initial data passed from Flask
      const initAlerts  = JSON.parse({{ init_alerts | safe }});
      const initSummary = JSON.parse({{ init_summary | safe }});

      const summaryBody = document.getElementById('summary-body');
      const totalEl     = document.getElementById('total-alerts');
      const alertsEl    = document.getElementById('alerts');

      // Initialise summary table
      for (const [model, count] of Object.entries(initSummary.model_votes)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${model}</td><td id="count-${model}">${count}</td>`;
        summaryBody.appendChild(tr);
      }
      totalEl.textContent = initSummary.total_alerts;

      // Initialise alert feed
      initAlerts.forEach(alert => {
        const div = document.createElement('div');
        div.className = 'alert';
        div.textContent = `${alert.time} – ALERT from ${alert.src_ip} (votes: ${JSON.stringify(alert.votes)})`;
        alertsEl.appendChild(div);
      });

      // Setup SocketIO
      const socket = io();

      socket.on('new_alert', data => {
        // Update counters
        for (const [model, vote] of Object.entries(data.votes)) {
          const cell = document.getElementById(`count-${model}`);
          const newCount = parseInt(cell.textContent) + vote;
          cell.textContent = newCount;
        }
        totalEl.textContent = parseInt(totalEl.textContent) + 1;

        // Prepend to feed
        const div = document.createElement('div');
        div.className = 'alert';
        div.textContent = `${data.time} – ALERT from ${data.src_ip} (votes: ${JSON.stringify(data.votes)})`;
        alertsEl.prepend(div);
      });

      socket.on('run_summary', summary => {
        // Finalise counters if needed
        for (const [model, count] of Object.entries(summary.model_votes)) {
          const cell = document.getElementById(`count-${model}`);
          cell.textContent = count;
        }
        totalEl.textContent = summary.total_alerts;
      });
    </script>
  </body>
</html>
