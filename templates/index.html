<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>IoT Cyber-Range Dashboard</title>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:1em auto; max-width:800px; }
    table { width:100%; border-collapse:collapse; margin:1em 0; }
    th, td { padding:0.5em; border:1px solid #ccc; }
    th { background:#f0f0f0; }
    .alert { background:#ffecec; border:1px solid #f5aca6;
             border-radius:4px; padding:0.75em; margin-bottom:0.5em; }
  </style>
</head>
<body>
  <h1>Real-Time IoT Alerts</h1>

  <section id="summary">
    <h2>Model Vote Counters</h2>
    <table>
      <thead><tr><th>Model</th><th>Positive Votes</th></tr></thead>
      <tbody id="summary-body"></tbody>
    </table>
    <p><strong>Total Alerts:</strong> <span id="total-alerts">0</span></p>
  </section>

  <section id="alerts">
    <h2>Alert Feed</h2>
  </section>

  <script>
    // initial state embedded by Flask
    const initAlerts  = {{ init_alerts  | safe }};
    const initSummary = {{ init_summary | safe }};
    const summaryBody = document.getElementById('summary-body');
    const totalEl     = document.getElementById('total-alerts');
    const alertsEl    = document.getElementById('alerts');

    // populate summary
    for (const [model, count] of Object.entries(initSummary.model_votes)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${model}</td><td id="count-${model}">${count}</td>`;
      summaryBody.appendChild(tr);
    }
    totalEl.textContent = initSummary.total_alerts;

    // populate past alerts
    initAlerts.forEach(alert => {
      const div = document.createElement('div');
      div.className = 'alert';
      div.textContent = `${alert.time} – ALERT from ${alert.src_ip}
                         (votes: ${JSON.stringify(alert.votes)})`;
      alertsEl.appendChild(div);
    });

    // connect SocketIO
    const socket = io();

    socket.on('new_alert', data => {
      // update counters
      for (const [model, vote] of Object.entries(data.votes)) {
        const cell = document.getElementById(`count-${model}`);
        cell.textContent = parseInt(cell.textContent) + vote;
      }
      totalEl.textContent = parseInt(totalEl.textContent) + 1;

      // prepend new alert
      const div = document.createElement('div');
      div.className = 'alert';
      div.textContent = `${data.time} – ALERT from ${data.src_ip}
                         (votes: ${JSON.stringify(data.votes)})`;
      alertsEl.prepend(div);
    });

    socket.on('run_summary', summary => {
      // finalise if needed
      for (const [model, count] of Object.entries(summary.model_votes)) {
        document.getElementById(`count-${model}`).textContent = count;
      }
      totalEl.textContent = summary.total_alerts;
    });
  </script>
</body>
</html>
